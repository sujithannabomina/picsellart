// FILE PATH: storage.rules
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }
    function isImage() {
      return request.resource != null
        && request.resource.contentType.matches('image/.*');
    }
    function smallEnough() {
      // 15 MB limit per upload (change if you want)
      return request.resource.size < 15 * 1024 * 1024;
    }

    /********************************************************
     * PUBLIC PREVIEWS (WATERMARKED ONLY)
     * - These can be shown in Explore / ViewPhoto
     * - They are NOT the original paid file
     ********************************************************/
    match /public/images/{file=**} {
      allow read: if true;
      allow write: if false; // only admin/server should upload these
    }

    /********************************************************
     * SELLER UPLOADS (ORIGINALS / PAID FILES)
     * - Buyers must NOT be able to read directly
     ********************************************************/
    match /sellers/{uid}/{file=**} {
      allow write: if isOwner(uid) && isImage() && smallEnough();
      allow read: if isOwner(uid); // only seller can read their own originals
    }

    /********************************************************
     * BUYER UPLOADS (optional, if you add later)
     ********************************************************/
    match /buyers/{uid}/{file=**} {
      allow write: if isOwner(uid) && isImage() && smallEnough();
      allow read: if isOwner(uid);
    }

    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
