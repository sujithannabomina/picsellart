rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    // Basic validators
    function isImage() {
      // Accept common image types only
      return request.resource.contentType.matches('image/.*') &&
             !request.resource.contentType.matches('image/svg\\+xml');
    }

    function maxSize(bytes) {
      return request.resource.size < bytes;
    }

    /*******************************************
     * PUBLIC WATERMARKED IMAGES (read-only)
     * Path used for images visible on Explore/detail:
     * gs://.../public/images/{imageId}
     *******************************************/
    match /public/images/{imageId} {
      // Anyone can read & list public gallery
      allow read: if true;
      // No client writes; these should come from Cloud Functions only
      allow write: if false;
    }

    /*******************************************
     * USER ORIGINAL UPLOADS (private)
     * Path for originals before watermarking:
     * gs://.../users/{userId}/originals/{fileName}
     *******************************************/
    match /users/{userId}/originals/{fileName} {

      // CREATE: only owner can upload images; size <= 15MB; set metadata.ownerId
      allow create: if signedIn()
                    && uid() == userId
                    && isImage()
                    && maxSize(15 * 1024 * 1024)
                    // prevent overwriting existing object
                    && resource == null
                    // require owner metadata to match uploader
                    && request.resource.metadata.ownerId == uid();

      // READ/LIST: only owner
      allow read: if signedIn() && uid() == userId;

      // DELETE: only owner
      allow delete: if signedIn() && uid() == userId;

      // No client updates (re-uploads) to originals
      allow update: if false;
    }

    /*******************************************
     * USER AVATAR (small, private)
     * gs://.../users/{userId}/avatar/{fileName}
     *******************************************/
    match /users/{userId}/avatar/{fileName} {
      // Max 2MB, image only; allow replace (update) by owner
      allow create: if signedIn()
                    && uid() == userId
                    && isImage()
                    && maxSize(2 * 1024 * 1024)
                    && resource == null;

      allow update: if signedIn()
                    && uid() == userId
                    && isImage()
                    && maxSize(2 * 1024 * 1024);

      allow read, delete: if signedIn() && uid() == userId;
    }

    /*******************************************
     * RECEIPTS (generated by server)
     * gs://.../receipts/{userId}/{fileName}
     *******************************************/
    match /receipts/{userId}/{fileName} {
      // Owner can read; no client writes (server generates)
      allow read: if signedIn() && uid() == userId;
      allow write: if false;
    }

    /*******************************************
     * DEFAULT: deny everything else
     *******************************************/
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
