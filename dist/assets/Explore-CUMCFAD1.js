import{u as E,r as n,j as t}from"./index-C0VzZSJe.js";import{u as A,q as I,c as R,d as M,w as $,o as B,l as L,g as T,a as D,r as q,s as _}from"./AuthContext-XHCfx8-r.js";import{c as z,l as F}from"./loadRazorpay-C47nwxjB.js";const m=24,O=112,G="public/watermarked";function H(){return Array.from({length:O},(a,c)=>{const l=c+1;return{id:`sample-${l}`,title:"street photography",isSample:!0,storagePath:`${G}/sample${l}.jpg`,price:Q()}})}function Q(){const a=[99,149,199,249];return a[Math.floor(Math.random()*a.length)]}function J(){const{user:a}=A(),c=E(),[l,i]=n.useState([]),[o,d]=n.useState(1),[u,v]=n.useState(""),[N,g]=n.useState(!0),[y,P]=n.useState({});n.useEffect(()=>{(async()=>{try{g(!0);const e=H(),s=I(R(M,"photos"),$("status","==","active"),B("createdAt","desc"),L(500)),U=(await T(s)).docs.map(b=>{const r=b.data();return{id:b.id,title:r.title||"Untitled",isSample:!!r.isSample,watermarkedUrl:r.watermarkedUrl||"",price:r.price??0,ownerId:r.ownerId||"",tags:Array.isArray(r.tags)?r.tags:[],createdAt:r.createdAt||null,storagePath:r.watermarkedPath||""}}),k=[...e,...U];i(k)}catch(e){console.error(e),i([])}finally{g(!1)}})()},[]);async function S(e){if(e.watermarkedUrl)return e.watermarkedUrl;if(!e.storagePath)return"";if(y[e.storagePath])return y[e.storagePath];try{const s=await D(q(_,e.storagePath));return P(p=>({...p,[e.storagePath]:s})),s}catch(s){return console.warn("getDownloadURL failed:",e.storagePath,s),""}}const x=n.useMemo(()=>{const e=u.trim().toLowerCase();return e?l.filter(s=>`${s.title||""} ${(s.tags||[]).join(" ")}`.toLowerCase().includes(e)):l},[l,u]),h=Math.max(1,Math.ceil(x.length/m)),f=(o-1)*m,j=x.slice(f,f+m);function w(e){d(Math.max(1,Math.min(h,e))),window.scrollTo({top:0,behavior:"smooth"})}async function C(e){if(!a){c("/buyer/login");return}try{const s=await z({amount:Number(e.price)*100,currency:"INR",userId:a.uid,purchaseType:"photo",photoId:e.id,sellerId:e.isSample?"picsellart":e.ownerId||"picsellart",title:e.title||"Photo",isSample:!!e.isSample});await F({order:s,user:a,onSuccess:()=>{alert("Payment successful! Your HD download will appear in Buyer Dashboard."),c("/buyer/dashboard")}})}catch(s){console.error(s),alert("Could not start payment. Please try again.")}}return t.jsx("main",{className:"section",children:t.jsxs("div",{className:"container",children:[t.jsx("h1",{className:"page-title",children:"Explore"}),t.jsx("p",{className:"page-desc",children:"Browse Picsellart samples and community uploads."}),t.jsx("div",{style:{marginTop:10,display:"flex",gap:8},children:t.jsx("input",{className:"input",placeholder:"Search by title or tag…",value:u,onChange:e=>{v(e.target.value),d(1)},style:{flex:1}})}),N?t.jsx("div",{className:"card",style:{marginTop:16},children:t.jsx("div",{className:"card-body",children:"Loading photos…"})}):j.length===0?t.jsx("div",{className:"card",style:{marginTop:16},children:t.jsx("div",{className:"card-body",children:"No results."})}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"grid grid--4",style:{marginTop:16},children:j.map(e=>t.jsx(W,{item:e,getUrl:S,onBuy:C},`${e.isSample?"s":"u"}-${e.id}`))}),t.jsxs("div",{style:{marginTop:18,display:"flex",gap:8,justifyContent:"center"},children:[t.jsx("button",{className:"btn",onClick:()=>w(o-1),disabled:o<=1,children:"Prev"}),t.jsxs("div",{className:"muted",style:{padding:"8px 12px"},children:["Page ",o," / ",h]}),t.jsx("button",{className:"btn",onClick:()=>w(o+1),disabled:o>=h,children:"Next"})]})]})]})})}function W({item:a,getUrl:c,onBuy:l}){const[i,o]=n.useState(a.watermarkedUrl||"");return n.useEffect(()=>{let d=!0;return i||(async()=>{const u=await c(a);d&&o(u)})(),()=>{d=!1}},[a,i,c]),t.jsx("div",{className:"card",children:t.jsxs("div",{className:"card-body",children:[t.jsx("div",{style:{borderRadius:10,overflow:"hidden",marginBottom:8},children:i?t.jsx("img",{src:i,alt:a.title,style:{display:"block",width:"100%",height:180,objectFit:"cover"}}):t.jsx("div",{className:"skeleton",style:{height:180}})}),t.jsx("div",{style:{fontSize:14,fontWeight:600},children:a.title||"Untitled"}),t.jsxs("div",{className:"muted",style:{fontSize:13,marginBottom:8},children:["₹",a.price??0," • ",a.isSample?"Picsellart":"Seller"]}),t.jsxs("div",{style:{display:"flex",gap:8},children:[t.jsx("button",{className:"btn btn--brand",onClick:()=>l(a),children:"Buy"}),t.jsx("a",{className:"btn",href:`/photo/${encodeURIComponent(a.id)}`,onClick:d=>{d.preventDefault(),window.location.href=`/photo/${encodeURIComponent(a.id)}`},children:"Details"})]})]})})}export{J as default};
