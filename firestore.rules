// FILE PATH: firestore.rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }

    // =========================
    // Public read-only
    // =========================
    match /config/{doc} {
      allow read: if true;
      allow write: if false;
    }

    match /photos/{photoId} {
      allow read: if resource.data.visibility == "public";
      allow write: if false;
    }

    match /stats/{doc} {
      allow read: if true;
      allow write: if false;
    }

    // =========================
    // Buyer profile (your app uses /buyers/{uid})
    // =========================
    match /buyers/{uid} {
      allow read: if isOwner(uid);

      allow create: if isOwner(uid)
        && request.resource.data.keys().hasOnly([
          'uid','email','name','photoURL','role','createdAt','updatedAt'
        ]);

      allow update: if isOwner(uid)
        && request.resource.data.diff(resource.data).changedKeys()
            .hasOnly(['name','photoURL','updatedAt']);

      allow delete: if false;
    }

    // =========================
    // Seller docs (needed because SellerOnboarding writes from client)
    // =========================
    match /sellers/{uid} {
      allow read: if isOwner(uid);

      // Allow seller to create/update only their own doc, limited fields
      allow create: if isOwner(uid);

      allow update: if isOwner(uid)
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'name','phone','upiId','status','planId','subscriptionId','photoURL','email','updatedAt','createdAt','uid'
        ]);

      allow delete: if false;
    }

    // =========================
    // Purchases (BUYER) â€” read-only for buyer.
    // IMPORTANT: server writes purchases after verifying Razorpay signature.
    // =========================
    match /purchases/{purchaseId} {
      allow read: if signedIn() && resource.data.buyerUid == request.auth.uid;
      allow create, update, delete: if false;
    }

    // =========================
    // Server-only (Admin SDK bypasses rules)
    // =========================
    match /razorpay_plans/{doc} { allow read, write: if false; }
    match /subscriptions/{doc} { allow read, write: if false; }
    match /orders/{doc} { allow read, write: if false; }
    match /payments/{doc} { allow read, write: if false; }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
