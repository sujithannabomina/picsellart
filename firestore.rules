rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    match /photos/{id} {
      allow read: if true;

      allow create: if request.auth != null
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.keys().hasAll(["title","price","watermarkedUrl","originalPath","ownerUid","planId"])
        && request.resource.data.watermarkedUrl.matches('^https?://')
        && request.resource.data.price is number
        // Seller with active plan (not expired)
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "seller"
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.plan.id in ["starter","pro","elite"]
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.plan.expiresAt > request.time
        // price cap per plan (from user doc)
        && request.resource.data.price <= get(/databases/$(database)/documents/users/$(request.auth.uid)).data.plan.maxPricePerPhoto;

      allow update, delete: if request.auth != null
        && resource.data.ownerUid == request.auth.uid;
    }

    match /purchases/{id} {
      allow read: if request.auth != null && request.auth.uid == resource.data.buyerUid;
      allow create, update, delete: if false;
    }

    match /contact_messages/{id} {
      allow create: if true;
      allow read: if false;
    }

    match /payments/{id} {
      allow read, write: if false;
    }
  }
}
